# ğŸ“‹ å¯¹è¯è®°å½•åˆ†ææ€»ç»“

## ğŸ“Š å¯¹è¯æ¦‚è§ˆ

| é¡¹ç›® | å†…å®¹ |
|------|------|
| **æ–‡ä»¶** | `Implementing Tabbar Context Menu.md` |
| **è¡Œæ•°** | 3253 è¡Œ |
| **ä¸»é¢˜** | Single-file-page PDF é˜…è¯»å™¨ + TabBar å³é”®èœå• |
| **ç”¨æˆ·æ¶ˆæ¯** | çº¦ 25+ æ¡ |

---

## âœ… å·²å®Œæˆçš„åŠŸèƒ½

### 1ï¸âƒ£ **Single-file-page PDF é˜…è¯»å™¨ç³»ç»Ÿ**

| åŠŸèƒ½ | çŠ¶æ€ |
|------|------|
| Tab ç±»å‹æ‰©å±• (`single-file-page`) | âœ… |
| Pinia Store ([paper-reader.store.ts](cci:7://file:///d:/code/Large-scale%20integrated%20projec/Prisim-PaperLib---ProjectFolder/Prisim--PaperLib/apps/client/src/renderer/stores/paper-reader/paper-reader.store.ts:0:0-0:0)) | âœ… |
| DataSource å±‚ (Mock + Electron) | âœ… |
| PDF.js é›†æˆ (`PDFSinglePageViewer`) | âœ… |
| Electron IPC (`pdf.ipc.ts`) | âœ… |
| Preload API (`pdf.api.ts`) | âœ… |
| Tab å»é‡é€»è¾‘ | âœ… |
| PDF æ–‡æ¡£ LRU ç¼“å­˜ (5ä¸ª) | âœ… |
| Ctrl+æ»šè½®ç¼©æ”¾ | âœ… |
| å·¥å…·æ å±…ä¸­ | âœ… |
| ç¼©æ”¾æ¯”ä¾‹å“åº”å¼åŒæ­¥ | âœ… |
| paper-title è‹¹æœé£æ ¼è¾¹æ¡† | âœ… |

### 2ï¸âƒ£ **TabBar å³é”®ä¸Šä¸‹æ–‡èœå•**

| åŠŸèƒ½ | çŠ¶æ€ |
|------|------|
| macOS é£æ ¼èœå• UI | âœ… |
| å…³é—­æ ‡ç­¾é¡µ | âœ… |
| å…³é—­å…¶ä»–æ ‡ç­¾é¡µ | âœ… |
| å…³é—­æ‰€æœ‰æ ‡ç­¾é¡µ | âœ… |
| Home Tab ä¿æŠ¤ | âœ… |
| ç‚¹å‡»å¤–éƒ¨å…³é—­ | âœ… |
| éçº¿æ€§åŠ¨ç”» | âœ… |
| æš—è‰²æ¨¡å¼é€‚é… | âœ… |

---

## ğŸ“ æ–°å¢/ä¿®æ”¹çš„æ–‡ä»¶

```
apps/
â”œâ”€â”€ client/src/renderer/
â”‚   â”œâ”€â”€ composables/page-navigation/
â”‚   â”‚   â””â”€â”€ index.ts                    [ä¿®æ”¹] TabType, closeOtherTabs, closeAllTabs
â”‚   â”œâ”€â”€ stores/paper-reader/
â”‚   â”‚   â”œâ”€â”€ paper-reader.store.ts       [æ–°å¢] é˜…è¯»å™¨çŠ¶æ€ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ paper-reader.datasource.ts  [æ–°å¢] DataSource æ¥å£
â”‚   â”‚   â”œâ”€â”€ paper-reader.mock.ts        [æ–°å¢] Mock å®ç°
â”‚   â”‚   â””â”€â”€ paper-reader.electron.ts    [æ–°å¢] Electron å®ç°
â”‚   â””â”€â”€ views/MainPage/
â”‚       â”œâ”€â”€ tabbar/index.vue            [ä¿®æ”¹] å³é”®èœå•
â”‚       â””â”€â”€ content/single-file-page/
â”‚           â””â”€â”€ index.vue               [æ–°å¢] PDF é˜…è¯»å™¨é¡µé¢
â”œâ”€â”€ electron/
â”‚   â”œâ”€â”€ main/ipc/pdf/pdf.ipc.ts         [æ–°å¢] PDF IPC å¤„ç†å™¨
â”‚   â””â”€â”€ preload/apis/pdf/pdf.api.ts     [æ–°å¢] PDF Preload API
â””â”€â”€ shared/types/library/
    â””â”€â”€ library.type.ts                  [ä¿®æ”¹] PaperMeta.pdfPath
```

---

## ğŸ› å·²è§£å†³çš„å‘

### å‘1: pdfPath åªå­˜æ–‡ä»¶å
**é—®é¢˜**: `PaperMeta.filename` åªæ˜¯æ–‡ä»¶å,ä¸æ˜¯å®Œæ•´è·¯å¾„
**è§£å†³**: åœ¨ `library.service.ts` ä¸­æ·»åŠ  `fillPdfPath()` å‡½æ•°,è¿”å›å®Œæ•´è·¯å¾„

### å‘2: Vue å“åº”å¼ç ´å PDF.js å¯¹è±¡
**é—®é¢˜**: `ref<PDFDocumentProxy>` å¯¼è‡´ `Cannot read private member #pagePromises`
**è§£å†³**: ä½¿ç”¨ `shallowRef` ä»£æ›¿ `ref`

### å‘3: ArrayBuffer detached
**é—®é¢˜**: ArrayBuffer åœ¨å“åº”å¼ç³»ç»Ÿä¸­ä¼ é€’åè¢« detached
**è§£å†³**: æ”¹ä¸ºä¼ é€’è·¯å¾„,ç»„ä»¶å†…éƒ¨ç›´æ¥è°ƒç”¨ IPC è·å–æ•°æ®

### å‘4: Map å†…å¯¹è±¡ä¿®æ”¹ä¸è§¦å‘å“åº”å¼
**é—®é¢˜**: `Object.assign(state, updates)` ä¸è§¦å‘ Vue å“åº”å¼
**è§£å†³**: [readerStates.value.set(paperId, { ...state, ...updates })](cci:1://file:///d:/code/Large-scale%20integrated%20projec/Prisim-PaperLib---ProjectFolder/Prisim--PaperLib/apps/client/src/renderer/composables/page-navigation/index.ts:141:4-144:5)

### å‘5: PDFViewer è¦æ±‚ container ç»å¯¹å®šä½
**é—®é¢˜**: `Error: The container must be absolutely positioned`
**è§£å†³**: æ·»åŠ  `position: absolute` åˆ° `.pdf-container`

### å‘6: scoped æ ·å¼ä¸å½±å“ Teleport å…ƒç´ 
**é—®é¢˜**: Teleport åˆ° body çš„èœå•æ²¡æœ‰æ ·å¼
**è§£å†³**: ä½¿ç”¨ `:global(.tab-context-menu)`

---

## ğŸ—ï¸ æ¶æ„è¦ç‚¹

### åˆ†å±‚èŒè´£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Vue ç»„ä»¶ (GUI å±‚)                           â”‚
â”‚  - UI æ¸²æŸ“                                   â”‚
â”‚  - äº‹ä»¶å¤„ç†                                  â”‚
â”‚  - ä¸åŒ…å«ä¸šåŠ¡é€»è¾‘                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Composable (é€»è¾‘å±‚)                         â”‚
â”‚  - å¤ç”¨é€»è¾‘ (useTabManager)                  â”‚
â”‚  - ä¸šåŠ¡è§„åˆ™                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Pinia Store (çŠ¶æ€å±‚)                        â”‚
â”‚  - å•ä¸€æ•°æ®æº                                â”‚
â”‚  - çŠ¶æ€ç®¡ç†                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DataSource (æ•°æ®å±‚)                         â”‚
â”‚  - ç¯å¢ƒæ£€æµ‹ (Electron/Web)                   â”‚
â”‚  - æ•°æ®è·å–                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Store ä½œä¸ºå•ä¸€æ•°æ®æº

```typescript
// âœ… æ­£ç¡®: æ“ä½œé€šè¿‡ store
paperReaderStore.setZoomLevel(paperId, newScale)

// âŒ é”™è¯¯: ç›´æ¥æ“ä½œç¬¬ä¸‰æ–¹åº“
pdfViewer.currentScale = newScale
```

### å¤æ‚å¯¹è±¡å¤„ç†

```typescript
// âœ… ç¬¬ä¸‰æ–¹åº“å¯¹è±¡ä½¿ç”¨ shallowRef
const pdfDocument = shallowRef<PDFDocumentProxy | null>(null)

// âœ… å¤§æ•°æ®ä¼ è·¯å¾„è€Œéå¯¹è±¡
store.setPdfPath('/path/to/file.pdf')
// ç»„ä»¶å†…éƒ¨è‡ªå·±åŠ è½½
const data = await window.api.pdf.readPDF(pdfPath)
```

---

## ğŸ“ ç”¨æˆ·æ˜ç¡®è¦æ±‚

1. **DataSource è´Ÿè´£ç¯å¢ƒæ£€æµ‹**,Store åªåšçŠ¶æ€ç®¡ç†
2. **pdfPath å­˜å‚¨å®Œæ•´è·¯å¾„**,ä¸è®©å„ä¸šåŠ¡å•ç‹¬è®¡ç®—
3. **ä½¿ç”¨æœ¬åœ° pdfjs-dist**,ä¸ç”¨ CDN
4. **Ctrl+æ»šè½®ç¼©æ”¾åŸºäºå½“å‰æ¯”ä¾‹**,ä¸è·³è½¬åˆ°å›ºå®šæ¯”ä¾‹
5. **Store ä½œä¸ºå•ä¸€æ•°æ®æº**,UI å“åº” store å˜åŒ–
6. **TabBar å³é”®èœå•æ˜¯ä¸“ç”¨çš„**,ä¸æ˜¯å…¨å±€èœå•
7. **éçº¿æ€§åŠ¨ç”»**,hover æ·¡ç°è‰²

---

