# 论文库存储系统 - 端到端测试文档

> 版本: 1.1.0  
> 更新时间: 2024-11-30  
> 更新内容: 添加论文列表展示测试

---

## 1. 测试环境准备

### 1.1 启动开发服务器

```bash
# 进入项目目录
cd Prisim--PaperLib

# 安装依赖（如果还没有）
pnpm install

# 启动 Electron 开发模式
pnpm dev:electron
```

### 1.2 准备测试文件

准备几个 PDF 文件用于测试：
- `test-paper-1.pdf`
- `test-paper-2.pdf`
- `Attention Is All You Need.pdf`（可选，测试特殊文件名）

---

## 2. 测试用例

### 2.1 数据库管理

#### 测试 2.1.1：创建数据库（通过对话框）

**操作步骤**：
1. 打开应用
2. 点击「新建项目」卡片
3. 在弹出的对话框中：
   - 输入项目名称（必填）：`我的论文库`
   - 输入描述（可选）：`用于存放机器学习相关论文`
4. 点击「创建」按钮

**对话框 UI**：
```
┌─────────────────────────────────────────┐
│ 新建论文库                          [×] │
├─────────────────────────────────────────┤
│                                         │
│ 项目名称 *                              │
│ ┌─────────────────────────────────────┐ │
│ │ 我的论文库                          │ │
│ └─────────────────────────────────────┘ │
│ 将作为文件夹名称使用                    │
│                                         │
│ 描述                                    │
│ ┌─────────────────────────────────────┐ │
│ │ 用于存放机器学习相关论文             │ │
│ │                                     │ │
│ └─────────────────────────────────────┘ │
│                                  0/200  │
│                                         │
├─────────────────────────────────────────┤
│                      [取消]    [创建]   │
└─────────────────────────────────────────┘
```

**预期结果**：
- 对话框关闭
- 新卡片出现在列表**开头**
- 目录结构被创建：
  ```
  {LibraryPath}/我的论文库/
  ├── .metadata/
  │   ├── index.json
  │   └── tags.json
  ├── papers/
  └── _imports/
  ```

**验证方式**：
- 打开 `%APPDATA%/Electron/Data/Documents/` 查看目录结构
- 检查 `index.json` 内容：
  ```json
  {
    "version": "1.0.0",
    "lastUpdated": <timestamp>,
    "papers": {}
  }
  ```

---

#### 测试 2.1.2：创建数据库（表单验证）

**测试空名称**：
1. 打开新建对话框
2. 不输入名称，直接点击「创建」
3. **预期**：显示错误「请输入项目名称」

**测试非法字符**：
1. 输入名称：`test/paper<lib>`
2. 点击「创建」
3. **预期**：显示错误「名称包含非法字符」

**测试超长名称**：
1. 输入超过 50 个字符的名称
2. **预期**：输入框限制最多 50 个字符

---

#### 测试 2.1.3：删除数据库

**操作步骤**：
1. 右键点击一个数据库卡片
2. 选择「删除」

**预期结果**：
- 卡片从列表中移除
- 如果选择「同时删除文件」，目录被删除

---

### 2.2 论文导入（拖放）

#### 测试 2.2.1：拖放单个 PDF 到卡片

**操作步骤**：
1. 从文件管理器拖动 `test-paper-1.pdf`
2. 悬停在一个数据库卡片上
3. 释放鼠标

**预期结果**：
1. 拖拽时卡片显示蓝色边框和遮罩
2. 遮罩显示「释放以导入到 {数据库名}」
3. 释放后：
   - 控制台日志：`[ProjectDashboard] 导入 1 个文件到数据库 xxx`
   - 论文被添加到数据库
4. 目录结构：
   ```
   papers/
   └── test-paper-1.<id>/
       ├── test-paper-1.pdf
       └── meta.json
   ```
5. `index.json` 更新，包含新论文
6. 卡片的「论文数」+1

**验证 meta.json**：
```json
{
  "id": "<8位短UUID>",
  "dirname": "test-paper-1.<id>",
  "filename": "test-paper-1.pdf",
  "title": "test-paper-1",
  "authors": [],
  "tags": [],
  "fileSize": <size>,
  "addedAt": <timestamp>,
  "updatedAt": <timestamp>
}
```

---

#### 测试 2.2.2：拖放多个 PDF

**操作步骤**：
1. 选中多个 PDF 文件
2. 拖放到数据库卡片

**预期结果**：
- 所有 PDF 文件被导入
- 每个文件创建独立的论文目录
- `index.json` 包含所有新论文
- 卡片论文数正确更新

---

#### 测试 2.2.3：拖放非 PDF 文件

**操作步骤**：
1. 拖放 `.txt` 或 `.jpg` 文件到卡片

**预期结果**：
- 文件被忽略
- 不创建论文目录
- 控制台日志：`[ProjectDashboard] 没有有效的 PDF 文件`

---

### 2.3 _imports 文件监听

#### 测试 2.3.1：打开数据库启动监听

**操作步骤**：
1. 创建一个新数据库
2. 调用 `openDatabase(id)` 或在应用中打开数据库

**预期结果**：
- 控制台日志：`[Watcher] 开始监听: <path>/_imports`
- 监听器被注册

---

#### 测试 2.3.2：放入文件触发确认对话框

**前置条件**：
- 数据库已打开（监听已启动）

**操作步骤**：
1. 手动将 `test-paper-2.pdf` 复制到数据库的 `_imports/` 目录

**预期结果**：
1. 等待约 500ms（防抖）
2. 弹出确认对话框：
   ```
   ┌─────────────────────────────────┐
   │ 📄 检测到新文件                  │
   │                                  │
   │ 在 <数据库名> 中检测到 1 个 PDF 文件 │
   │ 来源：_imports 目录               │
   │ 是否将这些文件导入到论文库？       │
   │                                  │
   │              [取消]  [导入]       │
   └─────────────────────────────────┘
   ```

---

#### 测试 2.3.3：确认导入

**操作步骤**：
1. 在确认对话框中点击「导入」

**预期结果**：
- 论文被导入到 `papers/` 目录
- `_imports/` 中的原文件被复制（不删除）
- `index.json` 更新
- 对话框关闭

---

#### 测试 2.3.4：取消导入

**操作步骤**：
1. 在确认对话框中点击「取消」

**预期结果**：
- 论文不被导入
- `_imports/` 中的文件保留
- 对话框关闭

---

#### 测试 2.3.5：批量文件检测

**操作步骤**：
1. 同时复制多个 PDF 到 `_imports/`

**预期结果**：
- 防抖 500ms 后弹出一次确认对话框
- 对话框显示正确的文件数量
- 确认后所有文件批量导入

---

### 2.4 优先级队列

#### 测试 2.4.1：拖放优先于 _imports

**操作步骤**：
1. 同时：
   - 复制文件到 `_imports/`
   - 拖放文件到卡片

**预期结果**：
1. 先显示拖放的确认对话框（HIGH 优先级）
2. 确认/取消后，再显示 _imports 的确认对话框（NORMAL 优先级）

---

### 2.5 论文列表展示

#### 测试 2.5.1：选中卡片显示论文列表

**操作步骤**：
1. 右键点击一个有论文的数据库卡片
2. 查看右侧边栏

**预期结果**：
1. 右侧边栏显示卡片概览信息
2. 概览下方显示「论文列表」区域
3. 显示论文数量（如「3 篇」）
4. 列出所有论文，每个论文项包含：
   - PDF 图标
   - 论文标题（最多显示 2 行）
   - 作者（如「Vaswani, A. 等」）
   - 年份
   - 添加日期
   - 状态标签（已读/已标注）

**UI 示例**：
```
┌─────────────────────────────────────┐
│ 论文列表                    3 篇    │
├─────────────────────────────────────┤
│ 📄 Attention Is All You Need        │
│    Vaswani, A. 等 · 2017           │
│    1月15日            [已读][已标注] │
├─────────────────────────────────────┤
│ 📄 BERT: Pre-training of Deep...   │
│    Devlin, J. 等 · 2018            │
│    1月16日                  [已读]  │
├─────────────────────────────────────┤
│ 📄 GPT-3: Language Models are...   │
│    Brown, T. 等 · 2020             │
│    1月17日                          │
└─────────────────────────────────────┘
```

---

#### 测试 2.5.2：空论文列表

**操作步骤**：
1. 创建一个新数据库（无论文）
2. 右键选中该卡片

**预期结果**：
- 论文列表区域显示空状态：
  - 文件夹图标
  - 「暂无论文」
  - 「拖放 PDF 文件到卡片导入」提示

---

#### 测试 2.5.3：导入后列表实时更新

**操作步骤**：
1. 选中一个数据库卡片
2. 拖放新的 PDF 文件到该卡片
3. 观察右侧论文列表

**预期结果**：
- 导入成功后
- 论文列表自动更新
- 新论文出现在列表中
- 论文数量 +1

---

#### 测试 2.5.4：切换选中卡片

**操作步骤**：
1. 选中卡片 A（有 3 篇论文）
2. 右键选中卡片 B（有 5 篇论文）

**预期结果**：
- 论文列表切换为卡片 B 的论文
- 显示正确的论文数量（5 篇）
- 加载时显示「加载中...」状态

---

### 2.6 Web 模式（Mock 数据源）

#### 测试 2.6.1：Web 模式启动

**操作步骤**：
1. 使用 `pnpm dev` 启动（非 Electron）
2. 打开浏览器访问

**预期结果**：
- 控制台日志：`[DataCardStore] 使用 Mock 数据源`
- 显示预设的 Mock 数据卡片
- 拖放功能显示日志但不执行实际导入

---

## 3. 错误场景测试

### 3.1 文件路径不存在

**操作步骤**：
- 调用 `importPapers` 传入不存在的文件路径

**预期结果**：
- 该文件被跳过
- 其他有效文件正常导入

---

### 3.2 数据库不存在

**操作步骤**：
- 调用 `getPapers('invalid-id')`

**预期结果**：
- 抛出错误：`Database not found: invalid-id`

---

### 3.3 _imports 目录不存在

**操作步骤**：
- 打开一个 `_imports/` 目录被删除的数据库

**预期结果**：
- 日志：`[Watcher] _imports 目录不存在`
- 不启动监听
- 其他功能正常

---

## 4. 控制台日志参考

### 4.1 正常启动（Electron）

```
[DataCardStore] 使用 Electron 数据源
```

### 4.2 打开数据库

```
[Watcher] 开始监听: C:\Users\xxx\AppData\Roaming\Electron\Data\Documents\MyDB\_imports
```

### 4.3 拖放导入

```
[ProjectDashboard] 导入 2 个文件到数据库 abc123
```

### 4.4 _imports 检测

```
[Watcher] 检测到文件: C:\...\test.pdf
[Watcher] 入队: imports-folder, 文件数: 1, 优先级: NORMAL
[Watcher] 请求确认: MyDB, 文件数: 1
```

### 4.5 用户确认

```
[Watcher] 用户确认导入: MyDB
```

---

## 5. 数据文件检查清单

### 5.1 databases.json

位置：`%APPDATA%/Electron/Data/databases.json`

```json
[
  {
    "id": "abc12345",
    "name": "我的论文库",
    "path": "C:\\Users\\xxx\\AppData\\Roaming\\Electron\\Data\\Documents\\我的论文库",
    "createdAt": 1732978800000,
    "lastOpenedAt": 1732978800000,
    "paperCount": 5
  }
]
```

### 5.2 index.json

位置：`{DatabasePath}/.metadata/index.json`

```json
{
  "version": "1.0.0",
  "lastUpdated": 1732978800000,
  "papers": {
    "a1b2c3d4": {
      "id": "a1b2c3d4",
      "dirname": "Attention Is All You Need.a1b2c3d4",
      "filename": "Attention Is All You Need.pdf",
      "title": "Attention Is All You Need",
      "authors": [],
      "tags": [],
      "fileSize": 2048576,
      "addedAt": 1732978800000,
      "updatedAt": 1732978800000
    }
  }
}
```

---

## 6. 已知限制

1. **标签系统** - 暂未实现（按计划跳过）
2. **_imports 文件清理** - 当前导入后不自动删除原文件
3. **PDF 元数据解析** - 当前只从文件名提取标题，不解析 PDF 内容
4. **论文打开** - 点击论文项暂不打开 PDF（待实现）

---

## 7. 测试检查清单

### 数据库管理
- [ ] 点击新建项目弹出对话框
- [ ] 填写名称和描述后创建成功
- [ ] 表单验证（空名称、非法字符）
- [ ] 删除数据库

### 论文导入
- [ ] 拖放单个 PDF 导入
- [ ] 拖放多个 PDF 导入
- [ ] 拖放非 PDF 文件（忽略）

### _imports 监听
- [ ] _imports 检测弹出对话框
- [ ] 确认导入
- [ ] 取消导入
- [ ] 批量文件检测
- [ ] 优先级队列（拖放优先）

### 论文列表展示
- [ ] 选中卡片显示论文列表
- [ ] 空论文列表显示提示
- [ ] 导入后列表实时更新
- [ ] 切换卡片列表更新

### 其他
- [ ] Web 模式 Mock 数据
- [ ] 错误场景处理
